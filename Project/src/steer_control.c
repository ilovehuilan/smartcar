#include "common.h"
#include "steer_control.h"
#include "ftm.h"
#include "picture.h"
#include "oled.h"

#define  GER            1
#define serve_row       1
#define ServeKp_numL   80
#define ServeKp_numR   80
#define row_num        9     

/**********舵机相关控制*************/
//                            1     2    3     4    5     6      7    8     9    10    11     12
//float row_percent[row_num]={0.454,0.32,0.151,0.05,0.005,0.005,0.005,0.005,0.005};
//                            1     2    3   4    5    6   7     8    9
float row_percent[row_num]={0.25,0.25,0.25,0.08,0.08,0.08,0.01,0.01,0.01};

//float row_percent[row_num]={0.35,0.35,0.35,0.08,0.08,0.08,0.01,0.01,0.01};

int DeltaX=0;
int DeltaX_error=0;
int Control=0;
int Control_error=0;
extern int effective_line;
extern int centerline_save[H];
int abs(int error);

uint32_t  S_3010_centervalue=714;
uint32_t  Control_left_limit=810;
uint32_t  Control_right_limit=630;
//uint32_t  S_3010_centervalue=617;
//uint32_t  Control_left_limit=700;
//uint32_t  Control_right_limit=540;
/*========================================================================
*  函数名称:  S3010_init
*  功能说明：舵机初始化
*  创建时间：2015/04/13
*  修改时间：2015/04/14
*  参数说明：
========================================================================*/
void S3010_init()
{
      
          FTM_PWM_QuickInit(FTM3_CH0_PE05, kPWM_EdgeAligned, 50); // 0~1000表示0%~100%      占空比，占：整个周期。duty=我们需要的时间*频率*精度
          FTM_PWM_InvertPolarity(HW_FTM3,HW_FTM_CH0, kFTM_QD_InvertedPolarity);
          FTM_PWM_ChangeDuty(HW_FTM3, HW_FTM_CH0, S_3010_centervalue); 
}

/*========================================================================
*  函数名称:  steer_control
*  功能说明：舵机控制
*  创建时间：2015/04/13
*  修改时间：2015/04/14
*  参数说明：
========================================================================*/
void  steer_control()
{
//                  float Serve_KpL[8][ServeKp_numL]={0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,9.20,7.93,7.75,7.66,7.65,7.73,7.90,9.16,9.50,9.93,11.43,11,10.63,10.31,10.04,10.81,10.61,10.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.550,8.580,8.520,8.570,8.530,
//                                                    0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,9.20,7.93,7.75,7.66,7.65,7.73,7.90,9.16,9.50,9.93,11.43,11,10.63,10.31,10.04,10.81,10.61,10.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.550,8.580,8.520,8.570,8.530,
//                                                    0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,9.20,7.93,7.75,7.66,7.65,7.73,7.90,9.16,9.50,9.93,11.43,11,10.63,10.31,10.04,10.81,10.61,10.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.550,8.580,8.520,8.570,8.530,
//                                                    0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,9.20,7.93,7.75,7.66,7.65,7.73,7.90,9.16,9.50,9.93,11.43,11,10.63,10.31,10.04,10.81,10.61,10.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.550,8.580,8.520,8.570,8.530,
//                                                    0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,9.20,7.93,7.75,7.66,7.65,7.73,7.90,9.16,9.50,9.93,11.43,11,10.63,10.31,10.04,10.81,10.61,10.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.550,8.580,8.520,8.570,8.530,
//                                                    0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,9.20,7.93,7.75,7.66,7.65,7.73,7.90,9.16,9.50,9.93,11.43,11,10.63,10.31,10.04,10.81,10.61,10.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.550,8.580,8.520,8.570,8.530,
//                                                    0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,9.20,7.93,7.75,7.66,7.65,7.73,7.90,9.16,9.50,9.93,11.43,11,10.63,10.31,10.04,10.81,10.61,10.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.550,8.580,8.520,8.570,8.530,
//                                                    0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,9.20,7.93,7.75,7.66,7.65,7.73,7.90,9.16,9.50,9.93,11.43,11,10.63,10.31,10.04,10.81,10.61,10.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.550,8.580,8.520,8.570,8.530
//                                                   };
//                  float Serve_KpR[8][ServeKp_numR]={0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,7.20,7.93,7.75,7.66,7.65,9.73,9.90,11.16,9.50,9.93,11.43,11,11.63,11.31,11.04,10.81,13.61,13.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.750,8.780,8.820,8.870,8.930,
//                                                    0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,7.20,7.93,7.75,7.66,7.65,9.73,9.90,11.16,9.50,9.93,11.43,11,11.63,11.31,11.04,10.81,13.61,13.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.750,8.780,8.820,8.870,8.930,
//                                                    0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,7.20,7.93,7.75,7.66,7.65,9.73,9.90,11.16,9.50,9.93,11.43,11,11.63,11.31,11.04,10.81,13.61,13.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.750,8.780,8.820,8.870,8.930,
//                                                    0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,7.20,7.93,7.75,7.66,7.65,9.73,9.90,11.16,9.50,9.93,11.43,11,11.63,11.31,11.04,10.81,13.61,13.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.750,8.780,8.820,8.870,8.930,
//                                                    0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,7.20,7.93,7.75,7.66,7.65,9.73,9.90,11.16,9.50,9.93,11.43,11,11.63,11.31,11.04,10.81,13.61,13.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.750,8.780,8.820,8.870,8.930,
//                                                    0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,7.20,7.93,7.75,7.66,7.65,9.73,9.90,11.16,9.50,9.93,11.43,11,11.63,11.31,11.04,10.81,13.61,13.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.750,8.780,8.820,8.870,8.930,
//                                                    0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,7.20,7.93,7.75,7.66,7.65,9.73,9.90,11.16,9.50,9.93,11.43,11,11.63,11.31,11.04,10.81,13.61,13.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.750,8.780,8.820,8.870,8.930,
//                                                    0,1.91,2.68,2.54,2.49,3.52,4.64,5.85,5.15,5.53,7,7.56,7.20,7.93,7.75,7.66,7.65,9.73,9.90,11.16,9.50,9.93,11.43,11,11.63,11.31,11.04,10.81,13.61,13.45,13.32,13.21,13.11,13.03,12.95,12.87,12.79,12.70,12.60,12.49,12.38,12.26,12.13,12.01,11.88,11.76,11.63,11.51,11.39,11.27,11.16,11.05,10.94,10.83,10.73,10.63,10.54,10.44,10.35,10.27,10.19,10.11,10.04,9.980,9.920,9.870,9.830,9.790,9.760,8.740,8.720,8.720,8.720,8.730,8.750,8.780,8.820,8.870,8.930
//                                                   };
                                     
  float Serve_KpL[8][ServeKp_numL]={  0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063,
                                      0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063,
                                      0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063 ,
                                      0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063,
                                      0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063,
                                      0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063,
                                      0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063,
                                      0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063,
                                    };
    float Serve_KpR[8][ServeKp_numR]={  0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063,
                                      0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063,
                                      0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063 ,
                                      0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063,
                                      0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063,
                                      0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063,
                                      0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063,
                                      0, 0.8223, 0.9216, 1.012, 1.094, 1.167, 1.231, 1.286, 1.333, 1.371, 1.4, 1.42, 1.432, 1.435, 1.429, 1.414, 1.394, 1.37, 1.345, 1.318, 1.293, 1.269, 1.247, 1.228, 1.212, 1.2, 1.192, 1.185, 1.179, 1.17, 1.161, 1.151, 1.141, 1.131, 1.123, 1.116, 1.111, 1.108, 1.106, 1.103, 1.1, 1.095, 1.088, 1.08, 1.071, 1.061, 1.051, 1.041, 1.03, 1.02, 1.011, 1.002, 0.9934, 0.9855, 0.9782, 0.9716, 0.9656, 0.9604, 0.9559, 0.9521, 0.9492, 0.947, 0.9457, 0.9452, 0.9455, 0.9468, 0.9489, 0.9519, 0.9559, 0.9608, 0.9666, 0.9734, 0.9811, 0.9899, 0.9996, 1.01, 1.022, 1.035, 1.049, 1.063,
                                     };
    

  
//                  float Serve_Kd_in=112;//进弯
//                  float Serve_Kd_out=65;//出弯
    
                   float Serve_Kd_in=0;//进弯
                  float Serve_Kd_out=0;//出弯
                  
                  int i=0;
                  int row=0;
                  int DeltaX_last=0;  //上一次的偏差量
                  float center_err=0;      //浮点型中线加权量
                  
                  //判断中线大致趋势，中线归一化
                  if(effective_line>=0)        
                  {
                    if(centerline[H/GER-1]<centerline[effective_line])
                      for(row=effective_line;row>0;row--)
                        centerline[row]=W;
                    else if(centerline[H/GER-1]>centerline[effective_line])
                      for(row=effective_line;row>0;row--)
                        centerline[row]=0;
                    else 
                    {
                      for(row=effective_line;row>0;row--)
                        centerline[row]=W/2;
                    }
                  }
                   //中线加权
                  for(row=22;row<48;row++)    
                  {
                    if(row==22 || row==24 || row==26 || row==33 || row==35 || row==37 || row==44 || row==46 || row==48)
                    {
                      center_err+=(W/2-centerline[row])*row_percent[i];
                      i++;
                    }
                  }
          
                  /******************/
                  /*****坡道判断*****/
                  /*****选择控制行****/
                /////偏差
                DeltaX_last=DeltaX;
//                if(ramp_flag >= 1 )
//                {
//                    DeltaX=centerline[42]-W/2;
//                }
//                else
//                {
//                  DeltaX=-(int)((center_err));
                DeltaX=center_err;
//                }
   
                Control_error=DeltaX-DeltaX_last;
                /******************/
                /*****小S路径优化**/
                /*******削弱偏差***/
                
                ///偏差限幅
                if(DeltaX>=W/2) DeltaX=W/2;
                if(DeltaX<=-W/2) DeltaX=-W/2;
//                Control_last=Control;
                
    

                ///舵机控制
//                if(abs(DeltaX)<ServeKp_numR) 
//                {
//                  ////Kp修改
//                  if(abs(DeltaX)>10 && abs(DeltaX)<60) 
//                  {
//                    Serve_KpR[serve_row][abs(DeltaX)]+=1.5;
//                    Serve_KpL[serve_row][abs(DeltaX)]+=1.8;
//                  }
//                  if(abs(DeltaX)>60)
//                  {
//                    Serve_KpR[serve_row][abs(DeltaX)]+=2.2;
//                    Serve_KpL[serve_row][abs(DeltaX)]+=1.5;
//                  }
                  //                if(abs(DeltaX)<ServeKp_numR) 
//                {
                  ////Kp修改
                  if(abs(DeltaX)>5 && abs(DeltaX)<60) 
                  {
                    Serve_KpR[serve_row][abs(DeltaX)]+=1;
                    Serve_KpL[serve_row][abs(DeltaX)]+=0.3;
                  }
                  if(abs(DeltaX)>=60 && abs(DeltaX)<80)
                  {
                    Serve_KpR[serve_row][abs(DeltaX)]+=1;
                    Serve_KpL[serve_row][abs(DeltaX)]+=0.3;
                  }
                
                
//                  if(abs(DeltaX)>60)
//                  {
//                    Serve_KpR[serve_row][abs(DeltaX)]+=2.2;
//                    Serve_KpL[serve_row][abs(DeltaX)]+=1.5;
//                  }
                  /******************/
                  /*****障碍识别*****/
                  /*****修改Kp值*****/
                
                  if(DeltaX>0&&DeltaX<ServeKp_numR)
                  {
                    if(DeltaX*(DeltaX-DeltaX_last)>0) Control=(int)(Serve_KpR[serve_row][abs(DeltaX)]*DeltaX+Serve_Kd_in*(DeltaX-DeltaX_last))+S_3010_centervalue;
                    else if(DeltaX*(DeltaX-DeltaX_last)<=0) Control=(int)(Serve_KpR[serve_row][abs(DeltaX)]*DeltaX+Serve_Kd_out*(DeltaX-DeltaX_last))+S_3010_centervalue;
                  }
                  else if(DeltaX<=0&&DeltaX>-ServeKp_numR)
                  {
                    if(DeltaX*(DeltaX-DeltaX_last)>0) Control=(int)(Serve_KpL[serve_row][abs(DeltaX)]*DeltaX+Serve_Kd_in*(DeltaX-DeltaX_last))+S_3010_centervalue;
                    else if(DeltaX*(DeltaX-DeltaX_last)<=0) Control=(int)(Serve_KpL[serve_row][abs(DeltaX)]*DeltaX+Serve_Kd_out*(DeltaX-DeltaX_last))+S_3010_centervalue;
                  }
//                }
                else if(DeltaX>=ServeKp_numR ) Control=Control_left_limit;
                else if(DeltaX<=-ServeKp_numR) Control=Control_right_limit;
                ///舵机限幅
                if(Control>Control_left_limit)  Control=Control_left_limit;
                if(Control<Control_right_limit) Control=Control_right_limit;
                ///赋值舵机
                FTM_PWM_ChangeDuty(HW_FTM3, HW_FTM_CH0, Control); 
                ///////oled显示
//                LCD_set_XY(0, 1);
//                LCD_write_english("DeltaX=");
//                LCD_write_int(DeltaX);
//                LCD_write_english(",");
//                LCD_write_int(DeltaX);
//
//
//                
//                LCD_set_XY(0, 2);
//                LCD_write_english("low=");
//                LCD_write_int(centerline[48]);
//                LCD_write_english(",");
//                LCD_write_int(centerline[46]);
//                LCD_write_english(",");
//                LCD_write_int(centerline[44]);
//                LCD_write_english(",");
//                LCD_write_int(centerline[44]);
//
//
//                LCD_set_XY(0, 3);
//                LCD_write_english("mediun=");
//                LCD_write_int(centerline[37]);
//                LCD_write_english(",");
//                LCD_write_int(centerline[35]);
//                LCD_write_english(",");
//                LCD_write_int(centerline[33]);
//                LCD_write_english(",");
//                LCD_write_int(centerline[33]);//////33,35,37
//
//
//                LCD_set_XY(0, 4);
//                LCD_write_english("hight=");
//                LCD_write_int(centerline[26]);
//                LCD_write_english(",");
//                LCD_write_int(centerline[24]);
//                LCD_write_english(",");
//                LCD_write_int(centerline[22]);
//                LCD_write_english(",");
//                LCD_write_int(centerline[22]);

                
}
/*========================================================================
*  函数名称:  S3010_set
*  功能说明：舵机赋值
*  创建时间：2015/04/13
*  修改时间：2015/04/14
*  参数说明：
========================================================================*/
void S3010_set(uint32_t pwm)
{

  FTM_PWM_ChangeDuty(HW_FTM3, HW_FTM_CH0, pwm); 
}

int abs(int error)
{
  if(error<0)
    error = 0-error;
  return error;
}